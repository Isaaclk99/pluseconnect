async function login() {
    const nameField = document.getElementById('logName').value.trim();
    const roomField = document.getElementById('logRoom').value.trim().toUpperCase();

    if (!nameField || !roomField) return alert("Please enter both Name and Room Code");

    // CRITICAL FOR MOBILE: Unlock audio on the very first user interaction
    const player = document.getElementById('musicPlayer');
    player.play().then(() => player.pause()).catch(() => { });

    // Visual feedback that the server is waking up
    const loginBtn = document.getElementById('loginBtn');
    const originalText = loginBtn.innerText;
    loginBtn.innerText = "Waking up server...";
    loginBtn.disabled = true;

    try {
        // Increase the fetch timeout logic or just handle the error gracefully
        const res = await fetch(`${BACKEND_URL}/api/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ roomCode: roomField, myName: nameField })
        });

        if (res.ok) {
            const data = await res.json();
            myName = nameField;
            myRoom = roomField;

            document.getElementById('letterBody').innerText = data.letter;
            document.getElementById('pulse-count').innerText = `${data.pulseCount} Pulses`;
            player.src = songPaths[data.song] || songPaths.perfect;

            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('game-interface').style.display = 'block';

            // MOBILE OPTIMIZED SOCKET INITIALIZATION
            socket = io(BACKEND_URL, {
                transports: ['polling', 'websocket'], // Try polling first for mobile stability
                reconnectionAttempts: 5,
                timeout: 20000 // Give the server 20 seconds to respond
            });

            setupSocketListeners();
            socket.emit('join-room', myRoom);
        } else {
            alert("Login failed. Check room code or name.");
            loginBtn.innerText = originalText;
            loginBtn.disabled = false;
        }
    } catch (e) {
        // This is where the phone usually fails because Render is slow to start
        alert("The server is still waking up. Please wait 10 seconds and try 'Enter Space' again!");
        loginBtn.innerText = originalText;
        loginBtn.disabled = false;
    }
}

// Ensure heart clicks work well on touch devices
document.getElementById('heart').addEventListener('touchstart', (e) => {
    // Prevent double-tap to zoom on mobile
    e.preventDefault(); 
    const touch = e.touches[0];
    const x = touch.clientX / window.innerWidth, y = touch.clientY / window.innerHeight;
    
    if (socket) socket.emit('send-pulse', { roomId: myRoom, x, y });
    triggerVisuals(x, y, true);

    const heart = document.getElementById('heart');
    heart.style.transform = "scale(1.2)";
    setTimeout(() => heart.style.transform = "scale(1)", 100);
}, {passive: false});
